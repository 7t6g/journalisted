#!/usr/bin/env python
#

import sys
import re
from datetime import datetime

sys.path.append( "../pylib" )

from JL import DB


htmlstrip = re.compile( '<.*?>', re.UNICODE|re.DOTALL )

def main():
	conn = DB.Connect()
	cu = conn.cursor()
	cu.execute( "DELETE FROM article_tag" )
	cu.execute( "SELECT id, content, title FROM article" )

	gentime = "%s" % ( datetime.now() )
	while 1:
		row = cu.fetchone()
		if not row:
			break

		article_id = row['id']
		txt = row['content'].decode('utf-8')

		htmlstrip.sub( '', txt )

		tags = ExtractTags( txt )

		c2 = conn.cursor()
		for tag,freq in tags.items():
			tag = tag.encode('utf-8')
			c2.execute( "INSERT INTO article_tag (article_id, tag, freq) VALUES (%s,%s,%s)",
				article_id, tag, freq )
		c2.close()

	conn.commit()

# extract phrases with the first letter of each word capitalised,
# but not at the beginning of a sentance.
tagpat = re.compile( u'[^.\\s]\\s*(([A-Z]\\w+)(\\s+([A-Z]\\w+))*)', re.UNICODE|re.DOTALL )


def ExtractTags( txt ):
	tags = {}
	for m in tagpat.findall(txt):
		t = ' '.join( m[0].split() )
		# ignore short tags unless they look like acronymns
		if len(t)<=3 and t != t.upper():
			continue
		tags[t] = tags.get(t,0) + 1
	return tags

if __name__ == "__main__":
    sys.exit(main())


