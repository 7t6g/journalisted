#!/usr/bin/env python
#
# Regenerate the article_stats table
#
# TODO: incremental update!

import sys
import re
from datetime import datetime

sys.path.append( "../pylib" )

from JL import DB


tagstrip = re.compile( '<.*?>', re.UNICODE|re.DOTALL )
ipat = re.compile( "\\bI\\b", re.UNICODE|re.DOTALL )

def main():
	conn = DB.Connect()
	cu = conn.cursor()
	cu.execute( "DELETE from article_stats" )
	cu.execute( "SELECT id, content, title FROM article" )

	gentime = "%s" % ( datetime.now() )
	while 1:
		row = cu.fetchone()
		if not row:
			break
		txt = row['content'].decode('utf-8')

		tagstrip.sub( '', txt )

		icount = len( ipat.findall( txt ) )
		# ultra-noddy wordcount
		wordcount = len( txt.split() )

		c2 = conn.cursor()
		c2.execute( "INSERT INTO article_stats (article_id,gentime,wordcount,icount) VALUES (%s,%s,%s,%s)",
			row['id'], gentime, wordcount, icount );
		c2.close()

	conn.commit()




if __name__ == "__main__":
    sys.exit(main())


